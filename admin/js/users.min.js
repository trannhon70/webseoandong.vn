document.addEventListener('DOMContentLoaded', (event) => {
    var local = 'http://localhost/namkhoa2.phongkhamdakhoanhatviet.vn';
    // var local = 'https://namkhoa2.phongkhamdakhoanhatviet.vn';

    function generateRandomString(length) {
        let result = '';
        let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let charactersLength = characters.length;
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

    function getCurrentDateTimeString() {
        let now = new Date();
        let year = now.getFullYear();
        let month = String(now.getMonth() + 1).padStart(2, '0');
        let day = String(now.getDate()).padStart(2, '0');
        let hours = String(now.getHours()).padStart(2, '0');
        let minutes = String(now.getMinutes()).padStart(2, '0');
        let seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}${hours}${minutes}${seconds}`;
    }

    function postData(url, data) {
        return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error("Request failed with status: " + xhr.status));
                    }
                }
            };
            xhr.send(JSON.stringify(data));
        });
    }

    function clearInputs(inputs) {
        for (let i = 0; i < inputs.length; i++) {
            let input = inputs[i];
            input.value = '';
        }
    }

    const submitButton = document.querySelector('button[name="submit"]');
    if (submitButton) {
        submitButton.addEventListener('click', async function(event) {
            event.preventDefault();
            let randomString = generateRandomString(8);
            let currentDateTimeString = getCurrentDateTimeString();
            let combinedString = randomString + currentDateTimeString;
            let ma_user = combinedString.substring(0, 16);

            let form = document.getElementById('form-create-user');
            let inputs = form.getElementsByTagName('input');
            let select = form.getElementsByTagName('select')[0];
            let formData = {};

            for (let i = 0; i < inputs.length; i++) {
                let input = inputs[i];
                formData[input.name] = input.value;
            }
            if (select.value !== "" && formData.user_name !== '' && formData.password !== '' && formData.full_name !== '' && formData.email !== '') {
                formData[select.name] = select.value;
                formData['ma_user'] = ma_user;
                try {
                    let response1 = await postData(`${local}/api/user/create-user.php`, formData);
                    if (response1.status === 'success') {
                        toastr.success(response1.message);
                        clearInputs(inputs);
                    } else {
                        toastr.error(response1.message);
                    }
                } catch (error) {
                    toastr.error("Đã xảy ra lỗi khi gọi API: " + error.message);
                }
            } else {
                toastr.error("Tất cả các trường không được bỏ trống!");
            }
        });
    }

    const submitUpdatePasswordButton = document.querySelector('button[name="submit-update-password"]');
    if (submitUpdatePasswordButton) {
        submitUpdatePasswordButton.addEventListener('click', async function(event) {
            event.preventDefault();
            const urlParams = new URLSearchParams(window.location.search);
            const url = urlParams.get('edit');
            let form = document.getElementById('form-create-user');
            let inputs = form.getElementsByTagName('input');
            let formData = {};

            for (let i = 0; i < inputs.length; i++) {
                let input = inputs[i];
                formData[input.name] = input.value;
            }
            formData['ma_user'] = url;
            if (formData.password !== '' && formData.confirm_password !== '') {
                if (formData.password === formData.confirm_password) {
                    try {
                        let response1 = await postData(`${local}/api/user/update-password.php`, formData);
                        if (response1.status === 'success') {
                            toastr.success(response1.message);
                            clearInputs(inputs);
                        } else {
                            toastr.error(response1.message);
                        }
                    } catch (error) {
                        toastr.error("Đã xảy ra lỗi khi gọi API: " + error.message);
                    }
                } else {
                    toastr.error("Mật khẩu nhập lại không đúng!");
                }
            } else {
                toastr.error("Mật khẩu không khớp hoặc trống!");
            }
        });
    }

    const togglePassword = document.querySelector("#togglePassword");
    const password = document.querySelector("#password");

    if (togglePassword && password) {
        togglePassword.addEventListener("click", function() {
            const type = password.getAttribute("type") === "password" ? "text" : "password";
            password.setAttribute("type", type);
            this.classList.toggle('fa-eye');
        });
    }

    const togglePasswordConfirm = document.querySelector("#togglePasswordConfirm");
    const confirmPassword = document.querySelector("#confirm_password");

    if (togglePasswordConfirm && confirmPassword) {
        togglePasswordConfirm.addEventListener("click", function() {
            const type = confirmPassword.getAttribute("type") === "password" ? "text" : "password";
            confirmPassword.setAttribute("type", type);
            this.classList.toggle('fa-eye');
        });
    }
});
